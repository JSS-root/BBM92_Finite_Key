(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 14.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       158,          7]
NotebookDataLength[     46161,       1209]
NotebookOptionsPosition[     45498,       1190]
NotebookOutlinePosition[     45895,       1206]
CellTagsIndexPosition[     45852,       1203]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["Finite-size BBM92  protocol", "Title",ExpressionUUID->"981d512e-46c6-46b4-aee5-57eacf081571"],

Cell[TextData[{
 StyleBox["DESCRIPTION:",
  FontWeight->"Bold"],
 " Implementing the finite key BBM92 protocol. Improve existing key rates by \
using an updated sampling bound to replace previous use of the Serfling \
bound. For details, consult:\n",
 StyleBox["Security Analysis of Quantum Key Distribution with Small Block \
Length and Its Application to Quantum Space Communications",
  FontSlant->"Italic"],
 ", Lim, Xu, Pan, Ekert, Phys. Rev. Lett. 126 (2021).\n\n",
 StyleBox["Approach:",
  FontWeight->"Bold"],
 " BRUTE FORCE. Reduced number of optimisation parameters from 4 to 3.\n\n",
 StyleBox["Details:",
  FontWeight->"Bold"],
 " A complete number of updates have been made over the BBM92_BruteForce \
file:\n\t1. Parallelised version for optimisation parameters. Implements \
ThreadMapping. Block optimisation left as sequential. \n\t2. Key rate is now \
applied to SatQKD scenario. Example loss file \
(clickfile_OGSsep_500km_phi_0_xi_0.csv) provided, directory must be \
specified.\n\t3. Block optimisation implemented for a satellite overpass.\n\t\
4. Input/output directories defined for generation of results.\n\t5. Runtime \
information provided\n\t6. Line comments provided. \n\n",
 StyleBox["Modularity:",
  FontWeight->"Bold"],
 " Code is performed in the following three independent steps:\n\t1. Module \
1: Loss selection and profile\n\t2. Module 2: Block and error rate \
calculations\n\t3. Module 3: Finite key rate optimisation\n\t\n\tThis \
structure prepares the ground work for future development in Python for \
integration with existing codebase and extension.\n\n",
 StyleBox["Date:",
  FontWeight->"Bold"],
 " 10th July 2025 - 10 August 2025\n",
 StyleBox["Author:",
  FontWeight->"Bold"],
 " Jasminder Sidhu\n"
}], "Text",ExpressionUUID->"9c54f83e-e77a-466b-ba76-d654d4785a65"],

Cell[BoxData[
 RowBox[{"Clear", "[", "\"\<Global`*\>\"", "]"}]], "Input",
 CellLabel->
  "In[110]:=",ExpressionUUID->"0a2eeee7-2844-4172-8d4b-481271732060"],

Cell[BoxData[
 RowBox[{"\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"--", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"START", " ", "OF", " ", "SCRIPT"}], "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"--", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"--", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"Step", " ", "1"}], ":", " ", 
    RowBox[{"Loss", " ", "selection", " ", "and", " ", "profile"}]}], "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{"--", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
   "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
   "EditData", " ", "function", " ", "to", " ", "process", " ", "data"}], 
   "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"editData", "[", "dataImport_", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"y", ",", "yN"}], "}"}], ",", 
      RowBox[{
       RowBox[{"y", "=", "dataImport"}], ";", "\[IndentingNewLine]", 
       RowBox[{"yN", "=", 
        RowBox[{"{", 
         RowBox[{"{", 
          RowBox[{
          "\"\<time\>\"", ",", "\"\<alice_dist\>\"", ",", 
           "\"\<alice_elev\>\"", ",", "\"\<alice_eff\>\"", ",", 
           "\"\<bob_dist\>\"", ",", "\"\<bob_elev\>\"", ",", 
           "\"\<bob_eff\>\"", ",", "\"\<tot_eff\>\"", ",", "\"\<tot_loss\>\"",
            ",", " ", "\"\<alice_Pbg\>\"", ",", " ", "\"\<bob_Pbg\>\""}], 
          "}"}], "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"yN", "=", 
        RowBox[{"Join", "[", 
         RowBox[{"yN", ",", 
          RowBox[{"Table", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "1"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "2"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "3"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "4"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "5"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "6"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "7"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "8"}], "]"}], "]"}], ",", 
              RowBox[{
               RowBox[{"-", "10"}], " ", 
               RowBox[{"Log10", "[", 
                RowBox[{"y", "[", 
                 RowBox[{"[", 
                  RowBox[{"j", ",", "8"}], "]"}], "]"}], "]"}]}], ",", " ", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "12"}], "]"}], "]"}], ",", 
              RowBox[{"y", "[", 
               RowBox[{"[", 
                RowBox[{"j", ",", "13"}], "]"}], "]"}]}], "}"}], ",", 
            RowBox[{"{", 
             RowBox[{"j", ",", "2", ",", 
              RowBox[{"Length", "[", "y", "]"}]}], "}"}]}], "]"}]}], "]"}]}], 
       ";", "\[IndentingNewLine]", "yN"}]}], "]"}]}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"lossdirectory", " ", "=", " ", "\"\<\>\""}], ";"}], 
   RowBox[{"(*", 
    RowBox[{
    "Specify", " ", "or", " ", "use", " ", "current", " ", "directory", " ", 
     "as", " ", "default"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"outdirectory", " ", "=", " ", "\"\<\>\""}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
    "datafile", " ", "=", " ", 
     "\"\<clickfile_OGSsep_500km_phi_0_xi_0.csv\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"dataImport", " ", "=", " ", 
     RowBox[{"Import", "[", 
      RowBox[{"StringJoin", "[", 
       RowBox[{"lossdirectory", ",", "datafile"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"data", " ", "=", " ", 
     RowBox[{"editData", "[", "dataImport", "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Step", " ", "2"}], ":", 
     RowBox[{
     "Block", " ", "and", " ", "Error", " ", "rate", " ", "calculations"}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PolError", "=", "0.001"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Pap", "=", "0.001"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"check", " ", "signif"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Pdc", "=", 
     RowBox[{"1", " ", 
      SuperscriptBox["10", 
       RowBox[{"-", "7"}]]}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"dark", " ", "count", " ", 
      RowBox[{"rate", "/", "s"}], " ", 
      RowBox[{"100", "/", "s"}], " ", "raw"}], ",", " ", 
     RowBox[{
      RowBox[{"10", "/", "s"}], " ", "in", " ", "coicidence", " ", "window", 
      " ", "per", " ", 
      RowBox[{"cycle", ".", " ", "Also"}], " ", "assume", " ", "stray", " ", 
      "light", " ", "is", " ", "included", " ", "in", " ", "this", " ", 
      "figure"}]}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PbgA", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"t", ",", "10"}], "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "2", ",", 
         RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"Background", " ", "probability", " ", "for", " ", "Alice"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PbgB", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"t", ",", "11"}], "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "2", ",", 
         RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"Background", " ", "probability", " ", "for", " ", "Bob"}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PecA", "=", " ", 
     RowBox[{"Pdc", " ", "+", " ", "PbgA", " ", "-", " ", 
      RowBox[{"Pdc", " ", "PbgA"}]}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "Alice", " ", "probability", " ", "that", " ", "either", " ", "a", " ", 
      "dark", " ", "count", " ", "or", " ", "a", " ", "background", " ", 
      "count", " ", "occurs"}], " ", "-", " ", 
     RowBox[{"union", " ", "of", " ", "independent", " ", "events"}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"PecB", "=", " ", 
     RowBox[{"Pdc", " ", "+", " ", "PbgB", " ", "-", " ", 
      RowBox[{"Pdc", " ", "PbgB"}]}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "Bob", " ", "probability", " ", "that", " ", "either", " ", "a", " ", 
      "dark", " ", "count", " ", "or", " ", "a", " ", "background", " ", 
      "count", " ", "occurs"}], " ", "-", " ", 
     RowBox[{"union", " ", "of", " ", "independent", " ", "events"}]}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"NoPass", "=", "1"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"This", " ", "is", " ", "number", " ", "of", " ", "overpasses"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Npulse", "=", 
     RowBox[{"NoPass", " ", 
      RowBox[{"(", 
       SuperscriptBox["10", "8"], ")"}]}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
     "rate", " ", "of", " ", "pair", " ", "production", " ", "in", " ", 
      "Hz"}], " ", "-", " ", 
     RowBox[{"includes", " ", "multi", " ", "photon", " ", "pairs"}]}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"FSeff", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"t", ",", "8"}], "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "2", ",", 
         RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"Total", " ", "elevation", " ", "dependent", " ", "loss"}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"FSAeff", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"t", ",", "4"}], "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "2", ",", 
         RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
    "Total", " ", "elevation", " ", "dependent", " ", "loss", " ", "for", " ",
      "Alice"}], " ", "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"FSBeff", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"data", "[", 
        RowBox[{"[", 
         RowBox[{"t", ",", "7"}], "]"}], "]"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", "2", ",", 
         RowBox[{"Length", "[", "data", "]"}]}], "}"}]}], "]"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{
    "Total", " ", "elevation", " ", "dependent", " ", "loss", " ", "for", " ",
      "Bob"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Eta]d", " ", "=", " ", "1.0"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"detector", " ", "efficiency"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Eta]Transmitter", " ", "=", " ", "1.0"}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"internal", " ", "telescope", " ", "transmitter", " ", "losses"}],
     "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"\[Eta]", "=", 
     RowBox[{"\[Eta]d", " ", "\[Eta]Transmitter"}]}], ";"}], " ", 
   RowBox[{"(*", 
    RowBox[{"Detector", " ", "and", " ", "Transmitter", " ", "losses"}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"ClickRate", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"(", 
         RowBox[{"1", "+", 
          SuperscriptBox["Pap", "2"]}], ")"}], 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"\[Eta]", " ", 
           RowBox[{"FSeff", "[", 
            RowBox[{"[", "t", "]"}], "]"}]}], " ", "+", " ", 
          RowBox[{"\[Eta]", " ", 
           RowBox[{"FSAeff", "[", 
            RowBox[{"[", "t", "]"}], "]"}], " ", 
           RowBox[{"(", 
            RowBox[{"1", "-", 
             RowBox[{"\[Eta]", " ", 
              RowBox[{"FSBeff", "[", 
               RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}], " ", 
           RowBox[{"PecB", "[", 
            RowBox[{"[", "t", "]"}], "]"}]}], " ", "+", " ", 
          RowBox[{"\[Eta]", " ", 
           RowBox[{"FSBeff", "[", 
            RowBox[{"[", "t", "]"}], "]"}], " ", 
           RowBox[{"(", 
            RowBox[{"1", "-", 
             RowBox[{"\[Eta]", " ", 
              RowBox[{"FSAeff", "[", 
               RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}], " ", 
           RowBox[{"PecA", "[", 
            RowBox[{"[", "t", "]"}], "]"}]}], " ", "+", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "-", 
             RowBox[{"\[Eta]", " ", 
              RowBox[{"FSeff", "[", 
               RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}], 
           RowBox[{"PecA", "[", 
            RowBox[{"[", "t", "]"}], "]"}], " ", 
           RowBox[{"PecB", "[", 
            RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}]}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", " ", "1", ",", " ", 
         RowBox[{"Length", "[", "FSeff", "]"}]}], "}"}]}], "]"}]}], ";"}], 
   " ", 
   RowBox[{"(*", 
    RowBox[{"Detection", " ", "rate"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mBlock", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"t", "+", "1"}], ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"ClickRate", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", "Npulse"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", " ", "1", ",", " ", 
         RowBox[{"Length", "[", "FSeff", "]"}]}], "}"}]}], "]"}]}], ";"}], 
   " ", 
   RowBox[{"(*", 
    RowBox[{
    "Time", " ", "with", " ", "Block", " ", "size", " ", "per", " ", 
     "second"}], "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"errorRate", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"\[Eta]", " ", 
          RowBox[{"FSAeff", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"\[Eta]", " ", 
             RowBox[{"FSBeff", "[", 
              RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}], " ", 
          RowBox[{"PecB", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"PecA", "[", 
             RowBox[{"[", "t", "]"}], "]"}]}], ")"}]}], "+", 
         RowBox[{"\[Eta]", " ", 
          RowBox[{"FSBeff", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"\[Eta]", " ", 
             RowBox[{"FSAeff", "[", 
              RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}], " ", 
          RowBox[{"PecA", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"PecB", "[", 
             RowBox[{"[", "t", "]"}], "]"}]}], ")"}]}], "+", 
         RowBox[{
          RowBox[{"PecA", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"PecB", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", 
          RowBox[{"(", 
           RowBox[{"1", "-", 
            RowBox[{"\[Eta]", " ", 
             RowBox[{"FSeff", "[", 
              RowBox[{"[", "t", "]"}], "]"}]}]}], ")"}]}], "+", 
         RowBox[{
          RowBox[{"(", 
           RowBox[{
            SuperscriptBox["Pap", "2"], " ", 
            RowBox[{"ClickRate", "[", 
             RowBox[{"[", "t", "]"}], "]"}]}], ")"}], "/", "2"}], "+", 
         RowBox[{"PolError", " ", 
          RowBox[{"(", 
           RowBox[{"\[Eta]", " ", 
            RowBox[{"FSeff", "[", 
             RowBox[{"[", "t", "]"}], "]"}]}], ")"}]}]}], ")"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", " ", "1", ",", " ", 
         RowBox[{"Length", "[", "FSeff", "]"}]}], "}"}]}], "]"}]}], ";"}], 
   " ", 
   RowBox[{"(*", 
    RowBox[{"Error", " ", "rate"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"mError", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"t", "+", "1"}], ",", "1"}], "]"}], "]"}], ",", 
         RowBox[{
          RowBox[{"errorRate", "[", 
           RowBox[{"[", "t", "]"}], "]"}], " ", "Npulse"}]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", " ", "1", ",", " ", 
         RowBox[{"Length", "[", "FSeff", "]"}]}], "}"}]}], "]"}]}], ";"}], 
   " ", 
   RowBox[{"(*", 
    RowBox[{"Error", " ", "block", " ", "size", " ", "per", " ", "second"}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"QBERList", " ", "=", " ", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
         RowBox[{"data", "[", 
          RowBox[{"[", 
           RowBox[{
            RowBox[{"t", "+", "1"}], ",", "1"}], "]"}], "]"}], ",", 
         FractionBox[
          RowBox[{"mError", "[", 
           RowBox[{"[", 
            RowBox[{"t", ",", "2"}], "]"}], "]"}], 
          RowBox[{"mBlock", "[", 
           RowBox[{"[", 
            RowBox[{"t", ",", "2"}], "]"}], "]"}]]}], "}"}], ",", 
       RowBox[{"{", 
        RowBox[{"t", ",", " ", "1", ",", " ", 
         RowBox[{"Length", "[", "FSeff", "]"}]}], "}"}]}], "]"}]}], ";"}], 
   " ", 
   RowBox[{"(*", 
    RowBox[{"QBER", " ", "list", " ", "values", " ", "per", " ", "second"}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"Step", " ", "3"}], ":", " ", 
     RowBox[{"Rate", " ", "optimisation"}]}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "Entropy"}]}], " ", 
      RowBox[{"Function", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"h2", "[", 
      RowBox[{"0", "|", "0."}], "]"}], "=", "0"}], ";"}], "\n", 
   RowBox[{
    RowBox[{
     RowBox[{"h2", "[", "x_", "]"}], ":=", 
     RowBox[{
      RowBox[{
       RowBox[{"-", "x"}], " ", 
       RowBox[{"Log2", "[", "x", "]"}]}], "-", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"1", "-", "x"}], ")"}], " ", 
       RowBox[{"Log2", "[", 
        RowBox[{"1", "-", "x"}], "]"}]}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"h2", ",", "Listable"}], "]"}], ";"}], "\n", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "Prepare"}]}], " ", 
      RowBox[{"thresholds", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{"thresholdMin", ",", "thresholdMax"}], "}"}], "=", 
     RowBox[{"MinMax", "[", 
      RowBox[{"QBERList", "[", 
       RowBox[{"[", 
        RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"NoSamples", "=", "100"}], ";"}], "\n", 
   RowBox[{
    RowBox[{"thresholdValues", "=", 
     RowBox[{"N", "@", 
      RowBox[{"Subdivide", "[", 
       RowBox[{"thresholdMin", ",", "thresholdMax", ",", 
        RowBox[{"NoSamples", "-", "1"}]}], "]"}]}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "Default"}]}], " ", "run", " ", 
      RowBox[{"parameters", "--"}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"s", "=", "6"}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"t", "[", "s_", "]"}], ":=", 
     RowBox[{"-", 
      RowBox[{"Log2", "[", 
       SuperscriptBox["10", 
        RowBox[{"-", " ", 
         RowBox[{"(", 
          RowBox[{"s", "+", "2"}], ")"}]}]], "]"}]}]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"tS", " ", "=", " ", 
     RowBox[{"t", "[", "s", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"eps0", "=", 
     SuperscriptBox["10", 
      RowBox[{"-", " ", "s"}]]}], ";"}], "\n", 
   RowBox[{
    RowBox[{"eps2", "=", 
     SuperscriptBox["10", 
      RowBox[{"-", " ", 
       RowBox[{"(", 
        RowBox[{"s", "+", "2"}], ")"}]}]]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{
      RowBox[{"--", 
       RowBox[{"-", "Main"}]}], " ", "Parallel", " ", "Loop", " ", "with", 
      " ", 
      RowBox[{"Reap", "/", 
       RowBox[{"Sow", "--"}]}]}], "-"}], "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"{", 
      RowBox[{"totalTimeNEW", ",", "Null"}], "}"}], "=", 
     RowBox[{"AbsoluteTiming", "[", 
      RowBox[{
       RowBox[{"FiniteRateOptData", "=", 
        RowBox[{
         RowBox[{"Reap", "[", 
          RowBox[{"Do", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"filteredQBER", "=", 
              RowBox[{"Select", "[", 
               RowBox[{"QBERList", ",", 
                RowBox[{
                 RowBox[{
                  RowBox[{"#", "[", 
                   RowBox[{"[", "2", "]"}], "]"}], "<=", 
                  RowBox[{"thresholdValues", "[", 
                   RowBox[{"[", "jj", "]"}], "]"}]}], "&"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"indices", "=", 
              RowBox[{"Flatten", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Position", "[", 
                  RowBox[{"QBERList", ",", "#"}], "]"}], "&"}], "/@", 
                "filteredQBER"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"filteredBlock", "=", 
              RowBox[{"mBlock", "[", 
               RowBox[{"[", "indices", "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"filteredError", "=", 
              RowBox[{"mError", "[", 
               RowBox[{"[", "indices", "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{"Define", " ", "constants"}], "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"\[Delta]", "=", 
              FractionBox[
               RowBox[{"Total", "[", 
                RowBox[{"filteredError", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}], 
               RowBox[{"Total", "[", 
                RowBox[{"filteredBlock", "[", 
                 RowBox[{"[", 
                  RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]]}], ";", " ", 
             RowBox[{"(*", 
              RowBox[{
              "Dynamic", " ", "for", " ", "improved", " ", "persformance"}], 
              "*)"}], "\[IndentingNewLine]", 
             RowBox[{"m", "=", 
              RowBox[{"Total", "[", 
               RowBox[{"filteredBlock", "[", 
                RowBox[{"[", 
                 RowBox[{"All", ",", "2"}], "]"}], "]"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"r", "=", 
              RowBox[{"1.19", " ", 
               RowBox[{"h2", "[", "\[Delta]", "]"}]}]}], ";", " ", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{
               "Length", " ", "of", " ", "error", " ", "correction", " ", 
                "syndrome"}], " ", "-", " ", 
               RowBox[{
               "block", " ", "size", " ", "accounted", " ", "for", " ", 
                "later", " ", "in", " ", "key", " ", "length", " ", 
                "expression"}]}], "*)"}], "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
              "Number", " ", "of", " ", "samples", " ", "for", " ", "each", 
               " ", "parameter"}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{"betaNo", "=", "120"}], ";", "\[IndentingNewLine]", 
             RowBox[{"xiNo", "=", "120"}], ";", "\[IndentingNewLine]", 
             RowBox[{"nuNo", "=", "120"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
               RowBox[{"Bounding", " ", "values"}], ";", " ", 
               RowBox[{"Emulate", " ", 
                RowBox[{"np", ".", "linspace"}], " ", "of", " ", "Python"}]}],
               "*)"}], "\[IndentingNewLine]", 
             RowBox[{"betas", " ", "=", " ", 
              RowBox[{"N", "@", 
               RowBox[{"Subdivide", "[", 
                RowBox[{
                 SuperscriptBox["10", 
                  RowBox[{"-", "6"}]], ",", " ", 
                 FractionBox["1", "2"], ",", " ", 
                 RowBox[{"betaNo", " ", "-", " ", "1"}]}], "]"}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"xis", " ", "=", " ", 
              RowBox[{"N", "@", 
               RowBox[{"Subdivide", "[", 
                RowBox[{"0", ",", " ", 
                 RowBox[{
                  FractionBox["1", "2"], "-", "\[Delta]"}], ",", " ", 
                 RowBox[{"xiNo", " ", "-", " ", "1"}]}], "]"}]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"nus", " ", "=", " ", 
              RowBox[{"N", "@", 
               RowBox[{"Subdivide", "[", 
                RowBox[{"0", ",", " ", 
                 RowBox[{
                  FractionBox["1", "2"], "-", "\[Delta]"}], ",", " ", 
                 RowBox[{"nuNo", " ", "-", " ", "1"}]}], "]"}]}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{
              "Define", " ", "all", " ", "necessary", " ", "functions"}], 
              "*)"}], "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"k", "[", 
               RowBox[{"\[Beta]_", ",", "m_"}], "]"}], ":=", 
              RowBox[{"Floor", "[", 
               RowBox[{"\[Beta]", " ", "m"}], "]"}]}], ";", " ", 
             RowBox[{"(*", 
              RowBox[{
              "Raw", " ", "key", " ", "length", " ", "used", " ", "for", " ", 
               "parameter", " ", "estimation"}], "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"n", "[", 
               RowBox[{"\[Beta]_", ",", "m_"}], "]"}], ":=", 
              RowBox[{"m", "-", 
               RowBox[{"k", "[", 
                RowBox[{"\[Beta]", ",", "m"}], "]"}]}]}], ";", " ", 
             RowBox[{"(*", 
              RowBox[{
              "Raw", " ", "key", " ", "length", " ", "used", " ", "for", " ", 
               "key", " ", "distillation"}], "*)"}], "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"\[CapitalGamma]", "[", 
               RowBox[{"x_", ",", "m_"}], "]"}], ":=", " ", 
              RowBox[{
               FractionBox["1", 
                RowBox[{"x", "+", "1"}]], " ", "+", " ", 
               FractionBox["1", 
                RowBox[{"m", "-", "x", "+", "1"}]]}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"\[Epsilon]pe", "[", 
               RowBox[{
               "\[Beta]_", ",", " ", "\[Nu]_", ",", " ", "\[Xi]_", ",", " ", 
                "m_"}], "]"}], ":=", " ", 
              RowBox[{
               SuperscriptBox[
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"Exp", "[", 
                   RowBox[{"-", 
                    FractionBox[
                    RowBox[{"2", "m", " ", 
                    RowBox[{"k", "[", 
                    RowBox[{"\[Beta]", ",", "m"}], "]"}], " ", 
                    SuperscriptBox["\[Xi]", "2"]}], 
                    RowBox[{
                    RowBox[{"n", "[", 
                    RowBox[{"\[Beta]", ",", "m"}], "]"}], "+", "1"}]]}], 
                   "]"}], "+", 
                  RowBox[{"Exp", "[", 
                   RowBox[{
                    RowBox[{"-", "2"}], " ", 
                    RowBox[{"\[CapitalGamma]", "[", 
                    RowBox[{
                    RowBox[{"m", " ", 
                    RowBox[{"(", 
                    RowBox[{"\[Delta]", " ", "+", " ", "\[Xi]"}], ")"}]}], 
                    ",", "m"}], "]"}], " ", 
                    RowBox[{"(", 
                    RowBox[{
                    RowBox[{
                    SuperscriptBox[
                    RowBox[{"n", "[", 
                    RowBox[{"\[Beta]", ",", "m"}], "]"}], "2"], " ", 
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{"\[Nu]", " ", "-", " ", "\[Xi]"}], ")"}], "2"]}], 
                    " ", "-", " ", "1"}], ")"}]}], "]"}]}], ")"}], 
                FractionBox["1", "2"]], "//", "Quiet"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"\[Epsilon]pa", "[", 
               RowBox[{"\[Beta]_", ",", "\[Nu]_", ",", "m_", ",", "l_"}], 
               "]"}], ":=", " ", 
              RowBox[{
               RowBox[{
                FractionBox["1", "2"], " ", 
                SqrtBox[
                 SuperscriptBox["2", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"-", 
                    RowBox[{"n", "[", 
                    RowBox[{"\[Beta]", ",", "m"}], "]"}]}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "-", 
                    RowBox[{"h2", "[", 
                    RowBox[{"\[Delta]", "+", "\[Nu]"}], "]"}], "-", "r"}], 
                    ")"}]}], " ", "+", " ", "tS", " ", "+", " ", "l"}]]]}], "//",
                "Quiet"}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"C1", "[", 
               RowBox[{
               "l_", ",", "m_", ",", "\[Beta]_", ",", "\[Nu]_", ",", "\[Xi]_",
                 ",", 
                RowBox[{"tol_", ":", 
                 SuperscriptBox["10", 
                  RowBox[{"-", "8"}]]}]}], "]"}], ":=", 
              RowBox[{
               RowBox[{"eps2", "+", 
                RowBox[{"2", " ", 
                 RowBox[{"\[Epsilon]pe", "[", 
                  RowBox[{"\[Beta]", ",", "\[Nu]", ",", "\[Xi]", ",", "m"}], 
                  "]"}]}], "+", 
                RowBox[{"\[Epsilon]pa", "[", 
                 RowBox[{"\[Beta]", ",", "\[Nu]", ",", "m", ",", "l"}], 
                 "]"}]}], "<=", 
               RowBox[{"eps0", " ", "+", " ", "tol"}]}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"DistributeDefinitions", "[", 
              RowBox[{
              "h2", ",", "k", ",", "n", ",", "t", ",", "\[CapitalGamma]", ",",
                "\[Epsilon]pe", ",", "\[Epsilon]pa", ",", "C1", ",", 
               "\[Delta]", ",", "s", ",", "r", ",", "m", ",", "betas", ",", 
               "nus", ",", "xis"}], "]"}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{"Brute", "-", 
               RowBox[{"force", " ", "optimisation"}]}], "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"FKresults", "=", 
              RowBox[{"ParallelTable", "[", 
               RowBox[{
                RowBox[{"Module", "[", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"\[Beta]", "=", 
                    RowBox[{"betas", "[", 
                    RowBox[{"[", "kk", "]"}], "]"}]}], ",", 
                    RowBox[{"\[Xi]", "=", 
                    RowBox[{"xis", "[", 
                    RowBox[{"[", "j", "]"}], "]"}]}], ",", 
                    RowBox[{"\[Nu]", "=", 
                    RowBox[{"nus", "[", 
                    RowBox[{"[", "i", "]"}], "]"}]}], ",", "l", ",", 
                    "isValid"}], "}"}], ",", 
                  RowBox[{
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"i", "<=", "j"}], ",", 
                    RowBox[{"Return", "[", "Nothing", "]"}]}], "]"}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"l", "=", 
                    RowBox[{
                    RowBox[{"Log2", "[", 
                    RowBox[{"4", " ", 
                    SuperscriptBox[
                    RowBox[{"(", 
                    RowBox[{"eps0", "-", "eps2", "-", 
                    RowBox[{"2", " ", 
                    RowBox[{"\[Epsilon]pe", "[", 
                    RowBox[{"\[Beta]", ",", "\[Nu]", ",", "\[Xi]", ",", "m"}],
                     "]"}]}]}], ")"}], "2"]}], "]"}], "+", 
                    RowBox[{
                    RowBox[{"n", "[", 
                    RowBox[{"\[Beta]", ",", "m"}], "]"}], " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "-", 
                    RowBox[{"h2", "[", 
                    RowBox[{"\[Delta]", "+", "\[Nu]"}], "]"}], "-", "r"}], 
                    ")"}]}], "-", "tS"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"isValid", "=", 
                    RowBox[{"C1", "[", 
                    RowBox[{
                    "l", ",", "m", ",", "\[Beta]", ",", "\[Nu]", ",", 
                    "\[Xi]"}], "]"}]}], ";", " ", "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{"isValid", ",", 
                    RowBox[{"{", 
                    RowBox[{"l", ",", "\[Beta]", ",", "\[Nu]", ",", "\[Xi]"}],
                     "}"}], ",", 
                    RowBox[{"{", 
                    RowBox[{"0", ",", "0", ",", "0", ",", "0"}], "}"}]}], 
                    "]"}]}]}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"kk", ",", 
                  RowBox[{"Length", "[", "betas", "]"}]}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"j", ",", 
                  RowBox[{"Length", "[", "xis", "]"}]}], "}"}], ",", 
                RowBox[{"{", 
                 RowBox[{"i", ",", 
                  RowBox[{"Length", "[", "nus", "]"}]}], "}"}]}], "]"}]}], 
             ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"FKresultsFlat", "=", 
              RowBox[{"DeleteCases", "[", 
               RowBox[{
                RowBox[{"Flatten", "[", 
                 RowBox[{"FKresults", ",", "2"}], "]"}], ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "0", ",", "0", ",", "0"}], "}"}]}], 
               "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"maxResult", "=", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{
                 RowBox[{"Length", "[", "FKresultsFlat", "]"}], "==", "0"}], 
                ",", 
                RowBox[{"{", 
                 RowBox[{"0", ",", "0", ",", "0", ",", "0"}], "}"}], ",", 
                RowBox[{
                 RowBox[{"SortBy", "[", 
                  RowBox[{"FKresultsFlat", ",", 
                   RowBox[{
                    RowBox[{"-", 
                    RowBox[{"First", "[", "#", "]"}]}], "&"}]}], "]"}], "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", 
              RowBox[{"Extract", " ", "result"}], "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{"maxLength", "=", 
              RowBox[{"Max", "[", 
               RowBox[{"0", ",", 
                RowBox[{"maxResult", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"\[Beta]", "=", 
              RowBox[{"maxResult", "[", 
               RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"\[Nu]", "=", 
              RowBox[{"maxResult", "[", 
               RowBox[{"[", "3", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"\[Xi]", "=", 
              RowBox[{"maxResult", "[", 
               RowBox[{"[", "4", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"Sow", "[", 
              RowBox[{"{", 
               RowBox[{"maxLength", ",", 
                RowBox[{"maxLength", "/", "m"}], ",", "m", ",", "s", ",", 
                "\[Delta]", ",", "\[Beta]", ",", "\[Nu]", ",", "\[Xi]", ",", 
                RowBox[{"thresholdValues", "[", 
                 RowBox[{"[", "jj", "]"}], "]"}]}], "}"}], "]"}], ";"}], ",", 
            
            RowBox[{"{", 
             RowBox[{"jj", ",", "1", ",", "10", ",", "1"}], "}"}]}], "]"}], 
          "]"}], "[", 
         RowBox[{"[", 
          RowBox[{"2", ",", "1"}], "]"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"(*", 
        RowBox[{"Add", " ", "header"}], "*)"}], "\[IndentingNewLine]", 
       RowBox[{"FiniteRateOpt", "=", 
        RowBox[{"Prepend", "[", 
         RowBox[{"FiniteRateOptData", ",", 
          RowBox[{"{", 
           RowBox[{
           "\"\<FKL\>\"", ",", "\"\<FKR\>\"", ",", "\"\<m\>\"", ",", 
            "\"\<s\>\"", ",", "\"\<delta\>\"", ",", "\"\<beta\>\"", ",", 
            "\"\<nu\>\"", ",", "\"\<xi\>\"", ",", "\"\<QBERthreshold\>\""}], 
           "}"}]}], "]"}]}], ";"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\n", 
   RowBox[{
    RowBox[{"Print", "[", 
     RowBox[{
     "\"\<Total time: \>\"", ",", "totalTimeNEW", ",", "\"\< seconds\>\""}], 
     "]"}], ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"Export", "[", 
     RowBox[{
      RowBox[{"StringJoin", "[", 
       RowBox[{"outdirectory", ",", "\"\<BlockSize/\>\"", ",", 
        RowBox[{"FileBaseName", "[", "datafile", "]"}], ",", 
        "\"\<_PolEr01_dc7_100MHz_TenDegree_FULLDATA.dat\>\""}], "]"}], ",", 
      "FiniteRateOpt"}], "]"}], ";"}], "\n", "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{"END", " ", "OF", " ", "SCRIPT"}], "*)"}], "\[IndentingNewLine]", 
   
   RowBox[{"(*", 
    RowBox[{"--", 
     RowBox[{"--", 
      RowBox[{"--", 
       RowBox[{"--", 
        RowBox[{"--", 
         RowBox[{"--", 
          RowBox[{"--", 
           RowBox[{"--", 
            RowBox[{"--", 
             RowBox[{"--", 
              RowBox[{"--", 
               RowBox[{"--", 
                RowBox[{"--", 
                 RowBox[{"--", 
                  RowBox[{"--", 
                   RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", 
                    RowBox[{"--", "--"}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}]}], 
    "*)"}], "\[IndentingNewLine]"}]}]], "Input",ExpressionUUID->"e1390800-\
3ff3-418b-a283-f05c6d7cc359"]
}, Open  ]]
},
WindowSize->{1379, 852},
WindowMargins->{{Automatic, 33}, {Automatic, 1}},
FrontEndVersion->"14.0 for Mac OS X ARM (64-bit) (December 12, 2023)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"c1a241a2-5f64-469a-a6fb-6bda5ce6629f"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[580, 22, 99, 0, 98, "Title",ExpressionUUID->"981d512e-46c6-46b4-aee5-57eacf081571"],
Cell[682, 24, 1813, 36, 541, "Text",ExpressionUUID->"9c54f83e-e77a-466b-ba76-d654d4785a65"],
Cell[2498, 62, 156, 3, 30, "Input",ExpressionUUID->"0a2eeee7-2844-4172-8d4b-481271732060"],
Cell[2657, 67, 42825, 1120, 3182, "Input",ExpressionUUID->"e1390800-3ff3-418b-a283-f05c6d7cc359"]
}, Open  ]]
}
]
*)

